<h1 align="center">Document of CShaperAPP</h1>


<p align="center">Authors: Jianfeng Cao, Lihan Hu, Hong Yan</p>

<h2>
  Introduction
</h2>
<p align="justify">This document describes the usage of CShaperAPP. CShaperAPP is built based on the CShaper published in <I>Nature Communications</I>, which adopts the deep learning to segmented the <I>C. elegans</I> emebyros at single-cell elevel (Cao JF <I>et al.</I>, <I>Nat. Commun</I>, 2020).</p>

<p align="justify">Generally speaking, CShaperAPP is composed of four functional sections, including <code>Preprocess</code>, <code>Segmentation</code>, <code>Analysis</code> and  <code>Result</code>. While these four parts are designed to be excuted sequentially, they can also be used to process or anlayze the data individually if data has already been prepared. In order to use this software efficiently, especially for <code>Segmentation</code>, GPU acceleration is preferred. However, all components has been tested successfully on basic desktop (RAM=16G, no GPU).</p>

<h2>Usage</h2>
<p align="justify">With the help of microscopy, fluorescent signals of nucleus and membrane are collected through two channels respectly. These images are saved slice by slice. <code>Preprocess</code> is used to composed these slices into a volume according to user's config. Subsequently, <code>Segmentation</code> is used to segment these volumetric images. <code>Analysis</code> is designed to collect biological information, such as volume and surface, from the segmentation result. Finally, <code>Result</code> can be used to inspect the segmentation results interactively.</p>

<h3>Folder Structure</h3>

The folders which are required or generated by CShaperAPP are listed here. 

```html
# 181210plc1p1 is the name of an embryo sample, which can be configured.

Raw Folder/: raw image folder
  |--181210plc1p1/: embryo name
     |--aceNuc/: nucleus lineage file from StarryNite and AceTree
     |--tif/: raw nucleus image
     |--tifR/: raw membrane image
Project Folder/: the target folder where all results will be saved
  |--CellMembrane/: binary membrane surface
  |--CellMembranePostseg/: segmentation results
     |--181210plc1p1/: cell segmentations without cell labels
     |--181210plc1p2LabelUnified/: cell segmentations whose labels can be queried
  |--NucleusLoc/: nucleus location information
  |--RawStack/: stacked membrane and nucleus images
  |--StatShape/: statistical results from the segmentations
     |--181210plc1/: embryo name
        |--181210plc1_contact.csv: cell-cell contact surface
        |--181210plc1_surface.csv: cell surface area
        |--181210plc1_volume.csv: cell volume
  |--TemCellGraph/: Temporary results 
Resource/: resources that are required by CShaperAPP
  |--number_dictionary.csv: pairwise cell name and digital label in the segmentation
  |--TrainedModel/: pretrained model for the deep learning framework
```

<p align="justify">In these files, <code>Raw Folder</code> is the data that the user needs to process. All data generated by CShaperAPP directly or indirectly will be saved to <code>Project Folder</code>. <code>Resource</code> is prequired files which are provided together with our paper. All </p>

<h3>Preprocess</h3>

<p style="align: justify">The user needs to set meta-information about the image data. An example data can be downloaded from <a href="https://portland-my.sharepoint.com/:u:/g/personal/jfcao3-c_my_cityu_edu_hk/EdOYHmsTunJFvMzX1hhh24ABleMOoSRexF9Dr_eUbYvBjw?e=XeEe4u">MembRaw</a> (0.2G) or <a href="https://portland-my.sharepoint.com/:u:/g/personal/jfcao3-c_my_cityu_edu_hk/EXk6zZW8wuJMjFEZQ005rysBOfBheOV253iVdZipIvbvqA?e=2hUUIM">MembRawFull</a> (1.88G). <code>MembRaw</code> only includes <I>time point=1~20</I> in <code>MembRawFull</code> in order to reduce the size of file to be downloaded or tested. The meaning of each parameters are listed as follows (based on the example data).</p>

<h4>Parameters</h4>

<details><summary>Parameter list</summary><div>


<table style="width: 80%">
  <tr>
    <th>Name</th>
    <th>Value</th>
    <th>Example</th>
  </tr>
  <tr>
    <td>Raw Folder</td>
    <td>name of raw data folder</td>
    <td>root/MembRaw</td>
  </tr>
  <tr>
    <td>Embryo Name</td>
    <td>Name of the embryo</td>
    <td>181210plc1p1</td>
  </tr>
  <tr>
    <td>X-Y Resolution</td>
    <td>Intra-slice resolution (&#956m)</td>
    <td>0.09</td>
  </tr>
  <tr>
    <td>Z Resolution</td>
    <td>Inter-slice resolution</td>
    <td>0.42</td>
  </tr>
  <tr>
    <td>Reduce Ratio</td>
    <td>The scale of image to be reduced. Setting this value to be smaller will reduce the time the <code>Segmentation</code> takes, but the resolution will be reduced</td>
    <td>0.3</td>
  <tr>
    <td>Slice Num</td>
    <td>The number of slices at each time point</td>
    <td>68</td>
  </tr>
  <tr>
    <td>Max Time</td>
    <td>The largest time points to be processed (start from t=1)</td>
    <td>100</td>
  </tr>
  <tr>
    <td>Lineage File</td>
    <td>The nucleus lineage file (from StarryNite and AceTree)</td>
    <td>root/MembRaw/181210plc1p1/aceNuc/CD181210plc1p1.csv</td>
  </tr>
  <tr>
    <td>Number Dictionary</td>
    <td>The dictionary used for finding out the cell name according to the segmentation results because only integers as opposed to strings are saved.</td>
    <td>root/Resource/number_dictionary.csv</td>
  </tr>
</table>
</div></details>

<h4>Results</h4>

<p align="justify">Membrane and nucleus slices are composed into a volume at each time point. The volumetric images are saved as <code>*.nii.gz</code> files under folder <code>Project Folder/MembRaw</code>, which can be loaded by <a href="http://www.itksnap.org/pmwiki/pmwiki.php">itk-SNAP</a>.</p>

<h3>Segmentation</h3>
<p>At this stage, some parameters are assumed to be the same as that of <code>Preprocess</code>. If not, the user can change the settings but please make sure the embryo to be segmented has been processed by stage <code>Preprocess</code>.</p>
<h4>Parameters</h4>
<details>
  <summary>Parameter list</summary><div>
  <table>
    <tr>
      <th>Name</th>
      <th>Value</th>
      <th>Example</th>
    </tr>
    <tr>
      <td>Project Folder</td>
      <td><code>Preprocess</code></td>
      <td><code>Preprocess</code></td>
    </tr>
    <tr>
      <td>Embryo Names</td>
      <td><code>Preprocess</code></td>
      <td><code>Preprocess</code></td>
    </tr>
    <tr>
      <td>Max Time<td>
      <td><code>Preprocess</code></td>
      <td><code>Preprocess</code></td>
    </tr>
    <tr>
      <td>Batch Size</td>
      <td>The number of images to be computed in parallel. The value should be set based on your computer resources (i.e. GPU).</td>
      <td>1</td>
    </tr>
    <tr>
      <td>Use Lineage</td>
      <td>Three cases: no lineage; after segmentation (used in CShaper, cell cavity can be detected); before segmentation (nuclei are used as seeds in watershed segmentation, so cell cavity cannot be detected)</td>
      <td>After Lineage</td>
    </tr>
    <tr>
      <td>Model File</td>
      <td>The file of pretrained model</td>
      <td>root/Resource/TrainedModel/DMapNet_pub_5000.ckpt</td>
    </tr>
  </table>
  </div>
</details>

<h4>Results</h4>

<p align="justify">Volumetric raw images are further segmented at single-cell level. Segmentations are saved at folder <code>Project Folder/181210plc1p2</code>. The user can <I>visually inspect the segmentation performance by loading the raw image (from <code>Preprocess</code>) and the segmentation with itk-SNAP</I>. Please note that at this stage, cells are not strictly lablled according to the `name_dictionary.csv`, which remains to be solved in <code>Analysis</code>.</p>

<h3>Analysis</h3>


